---
title: "Kendall Model"
author: "Kendall Fitzgerald"
date: "2025-04-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Invertebrates to include in analysis: purple urchin, sunflower sea star, northern kelp crab

## Setup
```{r}
#load necessary packages
library(here)
library(tidyverse)
library(dplyr)
library(naniar)
library(DHARMa)
library(gtsummary)
library(broom)
library(lme4)

#load dataset
inverts_kelp <- read_csv("PISCO_kelpforest_swath.1.2.csv")

```

```{r}
#tidy data
inverts_kelp <- inverts_kelp %>%
  filter(campus == "UCSC",
         classcode %in% c("PUGPRO", "STRPURAD", "PYCHEL", "MACPYRAD")) %>%
  #only include relevant columns for further analysis
  dplyr::select(campus, survey_year, site, zone, classcode, count, size, disease, depth)

#aggregate counts by site/year/species
inverts_summarized <- inverts_kelp %>%
  group_by(campus,site, survey_year, classcode, depth) %>%
  summarise(
    total_count = sum(count, na.rm = TRUE),
    zone = first(zone),
    .groups = "drop"
  )

#pivot to wide format
inverts_wide <- inverts_summarized %>%
  pivot_wider(
    names_from = classcode,
    values_from = total_count,
    values_fill = list(total_count = 0)
  )

 
```

## Step 1. Define Research Question
How does the presence of different invertebrates correlate with kelp abundance?

Null Hypothesis: Invertebrate presence does not have any correlation with kelp abundance.

Alternative Hypothesis: Invertebrate presence does have a correlation with kelp abundance.

## Step 2. Examine data and possible correlations
```{r}
#create and examine figures of raw values

#histograms of species count

#histogram of giant kelp
kelp_fig <- ggplot(inverts_wide, aes(y = MACPYRAD,
                                      x = survey_year)) +
  geom_bar(stat = "identity") +
   labs(y = "Giant Kelp",
       x = "Survey Year") +
  theme_bw()

kelp_fig

#histogram of Northern kelp crab
crab_fig <- ggplot(inverts_wide, aes(y = PUGPRO,
                                      x = survey_year)) +
  geom_bar(stat = "identity") +
  labs(y = "Northern Kelp Crab",
       x = "Survey Year") +
  theme_bw()

crab_fig

#histogram of Sunflower Sea Star
seastar_fig <- ggplot(inverts_wide, aes(y = PYCHEL,
                                      x = survey_year)) +
  geom_bar(stat = "identity") +
     labs(y = "Sunflower Sea Star",
       x = "Survey Year") +
  theme_bw()

seastar_fig

#histogram of purple urchin 
urchin_fig <- ggplot(inverts_wide, aes(y = STRPURAD,
                                      x = survey_year)) +
  geom_bar(stat = "identity") +
     labs(y = "Purple Urchin",
       x = "Survey Year") +
  theme_bw()

urchin_fig

```


### Performing correlation tests between independent variables
```{r}
# make dataframe with continuous predictor variables only
predictors <- inverts_wide %>%
  dplyr::select(PUGPRO, STRPURAD, PYCHEL)

# Calculate the correlation matrix
cor_matrix <- cor(predictors, use = "complete.obs")

# View the correlation matrix
cor_matrix
```

Because correlation does not exceed 0.6 between all variables, the test showed little to no correlation between the continuous predictor variables. Because of this, we can move forward with step 3. 

## Step 3 - Fit regression model
```{r}
# Check the mean and variance of the count variable for overdispersion
mean(inverts_kelp$count)
var(inverts_kelp$count)

inverts_wide$zone <- factor(inverts_wide$zone, levels = c("INNER", "MID", "OUTER"))

# Fit a Poisson GLM 
kelp_poisson <- glm(MACPYRAD ~ PUGPRO + STRPURAD + PYCHEL+ zone,
                    data = inverts_wide, 
                    family = poisson())


# View the summary of the model
summary(kelp_poisson)
```

