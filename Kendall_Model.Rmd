---
title: "Kendall Model"
author: "Kendall Fitzgerald"
date: "2025-04-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Invertebrates to include in analysis: purple urchin, sunflower sea star, northern kelp crab

## Setup
```{r}
#load necessary packages
library(here)
library(tidyverse)
library(dplyr)
library(naniar)
library(DHARMa)
library(gtsummary)
library(lme4)
library(MASS)

#load dataset
inverts_kelp <- read_csv("PISCO_kelpforest_swath.1.2.csv")

```

```{r}
#tidy data, addition of recruits and juveniles does not make a difference 
inverts_kelp <- inverts_kelp %>%
  filter(campus == "UCSC",
         classcode %in% c("PUGPRO", "STRPURAD", "PYCHEL", "MACPYRAD")) %>%
  #only include relevant columns for further analysis
  dplyr::select(campus, survey_year, site, zone, classcode, count, size, disease, depth)

inverts_summarized <- inverts_kelp %>%
  group_by(campus, site, survey_year, classcode, depth) %>%
  summarise(
    total_count = sum(count, na.rm = TRUE),
    zone = first(zone),
    .groups = "drop"
  )

# Group by species (classcode), year (survey_year), and zone
inverts_wide_grouped <- inverts_summarized %>%
  group_by(classcode, survey_year, zone) %>%
  summarise(across(c(total_count), sum, na.rm = TRUE), .groups = "drop")

# Pivot to wide format to separate out species
inverts_wide <- inverts_wide_grouped %>%
  pivot_wider(names_from = classcode, values_from = total_count, values_fill = list(total_count = 0))

```

## Step 1. Define Research Question
How does the presence of different invertebrates correlate with kelp abundance?

Null Hypothesis: Invertebrate presence does not have any correlation with kelp abundance.

Alternative Hypothesis: Invertebrate presence does have a correlation with kelp abundance.

## Step 2. Examine data and possible correlations
```{r}
#create and examine figures of raw values

#histograms of species count

#histograms of giant kelp
kelp_fig <- ggplot(inverts_wide, aes(x = MACPYRAD)) +
  geom_histogram() +
   labs(x = "Giant Kelp") +
  theme_bw()

kelp_fig

#histogram of Northern kelp crab
crab_fig <- ggplot(inverts_wide, aes(x = PUGPRO)) +
  geom_histogram() +
   labs(x = "Northern Kelp Crab") +
  theme_bw()

crab_fig

#histogram of Sunflower Sea Star
seastar_fig <- ggplot(inverts_wide, aes(x = PYCHEL)) +
  geom_histogram() +
   labs(x = "Sunflower Sea Star") +
  theme_bw()

seastar_fig

#histogram of purple urchin 
urchin_fig <- ggplot(inverts_wide, aes(x = STRPURAD)) +
  geom_histogram() +
   labs(x = "Purple Urchin") +
  theme_bw()

urchin_fig


#bar graph of zone distribution
zone_fig <- ggplot(inverts_kelp, aes(x = zone,
                                     y = count,
                                     fill = zone)) +
  geom_bar(stat = "identity") +
     labs(y = "Count",
       x = "Zone") +
  theme_bw()

zone_fig

```


### Performing correlation tests between independent variables
```{r}
# make dataframe with continuous predictor variables only
predictors <- inverts_wide %>%
  dplyr::select(PUGPRO, STRPURAD, PYCHEL)

# Calculate the correlation matrix
cor_matrix <- cor(predictors, use = "complete.obs")

# View the correlation matrix
cor_matrix

```

Because correlation does not exceed 0.6 between all variables, the test showed little to moderate correlation between the continuous predictor variables. Because of this, we can move forward with step 3. 

## Step 3 - Fit regression model
```{r}
# Check the mean and variance of the count variable
mean(inverts_wide$MACPYRAD)
var(inverts_wide$MACPYRAD)

#because the variance is significantly higher than the mean, we cannot use Poisson regression so we will move forward with negative binomial regression due to overdispersion

# Fit a negative binomial regression model
kelp_glm_nb <- glm.nb(MACPYRAD ~ PUGPRO + STRPURAD + PYCHEL + zone,
                       data = inverts_wide)

summary(kelp_glm_nb)

plot(kelp_glm_nb)

```


## Step 4 - Evaluate Model Diagnostics
```{r}
#Examine overall model output
summary(kelp_glm_nb)

#plot model output  
plot(kelp_glm_nb)



```

 

```{r}



```

